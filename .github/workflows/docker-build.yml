name: è‡ªåŠ¨æ„å»ºå¹¶æ¨é€å®¹å™¨é•œåƒ

on:
  push:
    branches: [ main ]
    tags: [ 'v*.*.*' ]

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # éœ€è¦writeæƒé™æ¥åˆ›å»ºtag
      packages: write

    steps:
      # æ£€å‡ºä»£ç ä»“åº“
      - name: æ£€å‡ºä»£ç ä»“åº“
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # æ£€å‡ºå®Œæ•´å†å²ä»¥è·å–å‡†ç¡®çš„æ ‡ç­¾ä¿¡æ¯

      # å®‰è£…buildah
      - name: å®‰è£…buildah
        run: |
          sudo apt-get update
          sudo apt-get install -y buildah
          buildah --version

      # ç™»å½•Docker Hub
      - name: ç™»å½•Docker Hub
        run: |
          echo "${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}" | buildah login -u "${{ secrets.DOCKER_HUB_USERNAME }}" --password-stdin docker.io

      # æå–é•œåƒå…ƒæ•°æ®ï¼ˆæ ‡ç­¾å’Œæ ‡ç­¾ï¼‰
      - name: æå–å®¹å™¨å…ƒæ•°æ®
        id: meta
        uses: docker/metadata-action@v4
        with:
          images: |
            ${{ github.repository }}
          tags: |
            type=ref,event=branch
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix={{branch}}-
            latest
          labels: |
            org.opencontainers.image.description=GoComicMosaicå¼€æºå½±è§†èµ„æºå…±å»ºå¹³å°
            org.opencontainers.image.source=${{ github.repositoryUrl }}
            org.opencontainers.image.version=${{ github.sha }}

      # æ„å»ºå¹¶æ¨é€å®¹å™¨é•œåƒ
      - name: ä½¿ç”¨buildahæ„å»ºé•œåƒ
        run: |
          # ç¡®ä¿æ„å»ºè„šæœ¬æœ‰æ‰§è¡Œæƒé™
          chmod +x ./build-with-buildah.sh
          
          # è¿è¡Œbuildahæ„å»ºè„šæœ¬
          ./build-with-buildah.sh
          
          # ä¸ºæ„å»ºçš„é•œåƒæ·»åŠ æ‰€æœ‰æ ‡ç­¾
          IMAGE_NAME="gocomicmosaic:latest"
          # å°†æ ‡ç­¾è¾“å‡ºè½¬æ¢ä¸ºæ•°ç»„ï¼ˆä½¿ç”¨æ¢è¡Œç¬¦ä½œä¸ºåˆ†éš”ç¬¦ï¼‰
          TAGS="${{ steps.meta.outputs.tags }}"
          while IFS= read -r tag; do
            if [ -n "$tag" ]; then
              echo "æ·»åŠ æ ‡ç­¾: $tag"
              buildah tag $IMAGE_NAME $tag
            fi
          done <<< "$TAGS"

      # æ¨é€é•œåƒ
      - name: æ¨é€é•œåƒåˆ°Docker Hub
        run: |
          # ä½¿ç”¨å®‰å…¨çš„æ–¹å¼è§£ææ ‡ç­¾åˆ—è¡¨
          TAGS="${{ steps.meta.outputs.tags }}"
          while IFS= read -r tag; do
            if [ -n "$tag" ]; then
              echo "æ¨é€: $tag"
              buildah push $tag
            fi
          done <<< "$TAGS"

      # æ›´æ–°ç‰ˆæœ¬å·ã€åˆ›å»ºtagå’ŒGitHub Release
      - name: æ›´æ–°ç‰ˆæœ¬å·ã€åˆ›å»ºtagå’ŒGitHub Release
        if: success() && github.ref == 'refs/heads/main'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # è¯»å–å½“å‰ç‰ˆæœ¬å·
          CURRENT_VERSION=$(cat version.txt)
          echo "å½“å‰ç‰ˆæœ¬: $CURRENT_VERSION"
          
          # å¢åŠ è¡¥ä¸ç‰ˆæœ¬å·ï¼ˆä¾‹å¦‚ä»1.0.0åˆ°1.0.1ï¼‰
          NEW_VERSION=$(echo $CURRENT_VERSION | awk -F. '{$3=$3+1; OFS="."; print $1,$2,$3}')
          echo "æ–°ç‰ˆæœ¬: $NEW_VERSION"
          
          # æ›´æ–°version.txtæ–‡ä»¶
          echo $NEW_VERSION > version.txt
          echo "âœ… ç‰ˆæœ¬å·å·²æ›´æ–°åˆ° $NEW_VERSION"
          
          # é…ç½®gitç”¨æˆ·
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'actions@github.com'
          
          # æ·»åŠ version.txtæ–‡ä»¶
          git add version.txt
          
          # æäº¤æ›´æ”¹
          git commit -m "è‡ªåŠ¨æ›´æ–°ç‰ˆæœ¬å·åˆ° $NEW_VERSION"
          
          # æ¨é€æ›´æ”¹
          git push origin main
          
          # åˆ›å»ºæ–°çš„tag
          TAG_NAME="v$NEW_VERSION"
          git tag $TAG_NAME
          git push origin $TAG_NAME
          echo "âœ… åˆ›å»ºå¹¶æ¨é€tag: $TAG_NAME"
          
          # è·å–æäº¤æ—¥å¿—ï¼Œç”¨äºReleaseè¯´æ˜
          CHANGELOG=$(git log --pretty=format:"- %s" $(git describe --tags --abbrev=0)..HEAD)
          
          # å®‰è£…ghå‘½ä»¤è¡Œå·¥å…·ï¼ˆGitHubå®˜æ–¹CLIï¼‰
          echo "å®‰è£…GitHub CLI..."
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          sudo apt-get update
          sudo apt-get install -y gh
          
          # åˆ›å»ºGitHub Release
          echo "åˆ›å»ºGitHub Release: $TAG_NAME"
          echo "å‘å¸ƒè¯´æ˜å†…å®¹:\n$CHANGELOG"
          
          # ä½¿ç”¨ghå‘½ä»¤åˆ›å»ºReleaseï¼ˆä½¿ç”¨ç¯å¢ƒå˜é‡ç›´æ¥è®¤è¯ï¼Œä¸éœ€è¦å•ç‹¬çš„loginæ­¥éª¤ï¼‰
          # ç¡®ä¿CHANGELOGä¸ä¸ºç©º
          if [ -z "$CHANGELOG" ]; then
            CHANGELOG="- è‡ªåŠ¨ç‰ˆæœ¬æ›´æ–°åˆ° $NEW_VERSION"
          fi
          
          # ç›´æ¥ä½¿ç”¨ç¯å¢ƒå˜é‡è¿›è¡Œè®¤è¯å’ŒReleaseåˆ›å»º
          # æ³¨æ„ï¼šGITHUB_TOKENå·²åœ¨ç¯å¢ƒå˜é‡ä¸­è®¾ç½®ï¼Œghå‘½ä»¤ä¼šè‡ªåŠ¨ä½¿ç”¨å®ƒ
          echo "åˆ›å»ºGitHub Release..."
          set +e  # å…è®¸å‘½ä»¤å¤±è´¥ä½†ç»§ç»­æ‰§è¡Œ
          gh release create "$TAG_NAME" \
            --title "GoComicMosaic v$NEW_VERSION" \
            --notes "## ç‰ˆæœ¬ $NEW_VERSION\n\n### æ›´æ–°å†…å®¹\n$CHANGELOG\n\n### é•œåƒä¿¡æ¯\n- Docker Hub: ${{ github.repository }}:$TAG_NAME\n- æ„å»ºæäº¤: ${{ github.sha }}" \
            --prerelease=false
            
          # æ£€æŸ¥å‘½ä»¤æ˜¯å¦æˆåŠŸ
          if [ $? -eq 0 ]; then
            echo "âœ… GitHub Release åˆ›å»ºæˆåŠŸ: https://github.com/${{ github.repository }}/releases/tag/$TAG_NAME"
          else
            echo "âš ï¸ GitHub Release åˆ›å»ºå¤±è´¥ï¼Œè¿™å¯èƒ½æ˜¯ç”±äºæƒé™é—®é¢˜æˆ–æ ‡ç­¾å·²å­˜åœ¨ã€‚"
            echo "ä½†tagå·²æˆåŠŸåˆ›å»ºå’Œæ¨é€ï¼Œç‰ˆæœ¬æ›´æ–°å·²å®Œæˆã€‚"
          fi
          set -e  # æ¢å¤é”™è¯¯ç«‹å³é€€å‡ºæ¨¡å¼

      # æ„å»ºå®Œæˆåçš„é€šçŸ¥
      - name: æ„å»ºå®Œæˆé€šçŸ¥
        if: success()
        run: |
          echo "âœ… å®¹å™¨é•œåƒæ„å»ºå¹¶æ¨é€æˆåŠŸï¼"
          echo "ğŸ” å¯ç”¨æ ‡ç­¾: ${{ steps.meta.outputs.tags }}"
          echo "ğŸ“¦ é•œåƒå¤§å°ä¼˜åŒ–: ä½¿ç”¨buildahæ„å»ºå‡å°ä½“ç§¯"
          echo "ğŸ“ æ„å»ºä¿¡æ¯: æäº¤SHA - ${{ github.sha }}"
          echo "âš¡ ä¼˜åŠ¿: ä¸Dockerç›¸æ¯”ï¼Œbuildahç”Ÿæˆçš„é•œåƒä½“ç§¯æ›´å°ï¼Œæ›´é€‚åˆç”Ÿäº§ç¯å¢ƒéƒ¨ç½²"
          if [ "${{ github.ref }}" = 'refs/heads/main' ]; then
            NEW_VERSION=$(cat version.txt)
            echo "ğŸš€ ç‰ˆæœ¬å·å·²æ›´æ–°åˆ° $NEW_VERSION å¹¶åˆ›å»ºäº†ç›¸åº”tag"
          fi

      # æ„å»ºå¤±è´¥æ—¶çš„æ•…éšœæ’é™¤ä¿¡æ¯
      - name: æ„å»ºå¤±è´¥æ•…éšœæ’é™¤
        if: failure()
        run: |
          echo "âŒ å®¹å™¨é•œåƒæ„å»ºå¤±è´¥ï¼"
          echo "ğŸ’¡ æ•…éšœæ’é™¤æç¤ºï¼š"
          echo "1. ç¡®ä¿Docker Hubå‡­è¯æ­£ç¡®è®¾ç½®åœ¨GitHub Secretsä¸­"
          echo "2. æ£€æŸ¥build-with-buildah.shè„šæœ¬è¯­æ³•æ˜¯å¦æ­£ç¡®"
          echo "3. éªŒè¯æ„å»ºç¯å¢ƒç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸"
          echo "4. æŸ¥çœ‹å®Œæ•´æ—¥å¿—ä»¥è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯"
          echo "5. ç¡®ä¿buildahå·¥å…·æ­£ç¡®å®‰è£…å¹¶å…·æœ‰è¶³å¤Ÿæƒé™"