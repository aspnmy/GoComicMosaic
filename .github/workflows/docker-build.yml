name: è‡ªåŠ¨æž„å»ºå¹¶æŽ¨é€å®¹å™¨é•œåƒ

on:
  push:
    branches: [ main ]
    tags: [ 'v*.*.*' ]

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # éœ€è¦writeæƒé™æ¥åˆ›å»ºtag
      packages: write

    steps:
      # æ£€å‡ºä»£ç ä»“åº“
      - name: æ£€å‡ºä»£ç ä»“åº“
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # æ£€å‡ºå®Œæ•´åŽ†å²ä»¥èŽ·å–å‡†ç¡®çš„æ ‡ç­¾ä¿¡æ¯

      # å®‰è£…buildah
      - name: å®‰è£…buildah
        run: |
          sudo apt-get update
          sudo apt-get install -y buildah
          buildah --version

      # ç™»å½•æ‰€æœ‰å®¹å™¨ä»“åº“
      - name: ç™»å½•å®¹å™¨ä»“åº“
        run: |
          # ç™»å½•Docker Hub
          echo "æ­£åœ¨ç™»å½•Docker Hub..."
          echo "${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}" | buildah login -u "${{ secrets.DOCKER_HUB_USERNAME }}" --password-stdin docker.io
          echo "âœ… Docker Hubç™»å½•æˆåŠŸ"
          
          # ç™»å½•GitHub Container Registry
          echo "æ­£åœ¨ç™»å½•GitHub Container Registry..."
          set +e  # å…è®¸ç™»å½•å¤±è´¥ä½†ç»§ç»­æ‰§è¡Œ
          echo "${{ secrets.GHCR_PUSH_TOKEN }}" | buildah login -u "${{ secrets.GHCR_NAME }}" --password-stdin ghcr.io
          GHCR_LOGIN_STATUS=$?
          set -e
          
          if [ $GHCR_LOGIN_STATUS -eq 0 ]; then
            echo "âœ… GitHub Container Registryç™»å½•æˆåŠŸ"
            echo "GHCR_LOGIN_SUCCESS=true" >> $GITHUB_ENV
          else
            echo "âŒ GitHub Container Registryç™»å½•å¤±è´¥ï¼Œé”™è¯¯ç : $GHCR_LOGIN_STATUS"
            echo "GHCR_LOGIN_SUCCESS=false" >> $GITHUB_ENV
          fi
          
          # ç™»å½•git.t2be.cn
          echo "æ­£åœ¨ç™»å½•git.t2be.cn..."
          set +e  # å…è®¸ç™»å½•å¤±è´¥ä½†ç»§ç»­æ‰§è¡Œ
          echo "${{ secrets.GIT2BE_PUSH_TOKEN }}" | buildah login -u "${{ secrets.GIT2BE_NAME }}" --password-stdin git.t2be.cn
          GIT2BE_LOGIN_STATUS=$?
          set -e
          
          if [ $GIT2BE_LOGIN_STATUS -eq 0 ]; then
            echo "âœ… git.t2be.cnç™»å½•æˆåŠŸ"
            echo "GIT2BE_LOGIN_SUCCESS=true" >> $GITHUB_ENV
          else
            echo "âŒ git.t2be.cnç™»å½•å¤±è´¥"
            echo "GIT2BE_LOGIN_SUCCESS=false" >> $GITHUB_ENV
          fi
          


      # è¯»å–ç‰ˆæœ¬å·ç”¨äºŽé•œåƒæ ‡ç­¾
      - name: è¯»å–ç‰ˆæœ¬å·
        id: version
        run: |
          VERSION=$(cat version.txt | tr -d '[:space:]')
          # å°†ä»“åº“åè½¬æ¢ä¸ºå°å†™ä»¥ç¬¦åˆDockerå‘½åè§„èŒƒ
          LOWERCASE_REPO=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "IMAGE_TAG=${VERSION}-alpine-sts" >> $GITHUB_OUTPUT
          echo "LOWERCASE_REPO=$LOWERCASE_REPO" >> $GITHUB_OUTPUT
          echo "è¯»å–åˆ°çš„ç‰ˆæœ¬å·: $VERSIONï¼Œé•œåƒæ ‡ç­¾: ${VERSION}-alpine-sts"

      # æž„å»ºå¹¶æŽ¨é€å®¹å™¨é•œåƒ
      - name: ä½¿ç”¨buildahæž„å»ºé•œåƒ
        run: |
          # ç¡®ä¿æž„å»ºè„šæœ¬æœ‰æ‰§è¡Œæƒé™
          chmod +x ./build-with-buildah.sh
          
          # è¿è¡Œbuildahæž„å»ºè„šæœ¬
          ./build-with-buildah.sh
          
          # ä¸ºæž„å»ºçš„é•œåƒæ·»åŠ åŸºäºŽç‰ˆæœ¬å·çš„æ ‡ç­¾
          IMAGE_NAME="gocomicmosaic:latest"
          LOWERCASE_REPO="${{ steps.version.outputs.LOWERCASE_REPO }}"
          VERSION_TAG="${{ steps.version.outputs.IMAGE_TAG }}"
          
          # ä»“åº“åˆ—è¡¨
          DOCKER_HUB_REPO="$LOWERCASE_REPO"
          GHCR_REPO="ghcr.io/${LOWERCASE_REPO}"
          GIT2BE_REPO="git.t2be.cn/${LOWERCASE_REPO}"
          PH_REPO="ph.nas.t2be.cn/${LOWERCASE_REPO}"
          
          # ä¸ºæ‰€æœ‰ä»“åº“æ·»åŠ æ ‡ç­¾
          echo "æ·»åŠ Docker Hubæ ‡ç­¾: $DOCKER_HUB_REPO:$VERSION_TAG"
          buildah tag $IMAGE_NAME $DOCKER_HUB_REPO:$VERSION_TAG
          
          echo "æ·»åŠ GitHub Container Registryæ ‡ç­¾: $GHCR_REPO:$VERSION_TAG"
          buildah tag $IMAGE_NAME $GHCR_REPO:$VERSION_TAG
          
          echo "æ·»åŠ git.t2be.cnæ ‡ç­¾: $GIT2BE_REPO:$VERSION_TAG"
          buildah tag $IMAGE_NAME $GIT2BE_REPO:$VERSION_TAG
          

          
          # ä¿å­˜æ ‡ç­¾ä¿¡æ¯ä¾›åŽç»­æ­¥éª¤ä½¿ç”¨
          echo "VERSION_TAG=$VERSION_TAG" >> $GITHUB_ENV
          echo "LOWERCASE_REPO=$LOWERCASE_REPO" >> $GITHUB_ENV
          echo "DOCKER_HUB_REPO=$DOCKER_HUB_REPO" >> $GITHUB_ENV
          echo "GHCR_REPO=$GHCR_REPO" >> $GITHUB_ENV
          echo "GIT2BE_REPO=$GIT2BE_REPO" >> $GITHUB_ENV

          echo "ä¿å­˜çš„å°å†™ä»“åº“å: $LOWERCASE_REPO"

      # æŽ¨é€é•œåƒåˆ°æ‰€æœ‰å®¹å™¨ä»“åº“
      - name: æŽ¨é€é•œåƒåˆ°æ‰€æœ‰å®¹å™¨ä»“åº“
        run: |
          VERSION_TAG="${VERSION_TAG}"
          
          # æŽ¨é€å‡½æ•° - å…è®¸å•ä¸ªæŽ¨é€å¤±è´¥ä½†ç»§ç»­æ‰§è¡Œ
          push_image() {
            local repo=$1
            local tag=$2
            local repo_name=$3
            
            echo "ðŸ“¦ æŽ¨é€é•œåƒåˆ° $repo_name: $repo:$tag"
            set +e  # å…è®¸æŽ¨é€å¤±è´¥ä½†ç»§ç»­æ‰§è¡Œå…¶ä»–æŽ¨é€
            buildah push $repo:$tag
            if [ $? -eq 0 ]; then
              echo "âœ… æˆåŠŸæŽ¨é€åˆ° $repo_name"
              return 0
            else
              echo "âŒ æŽ¨é€åˆ° $repo_name å¤±è´¥ï¼Œç»§ç»­å°è¯•å…¶ä»–ä»“åº“"
              return 1
            fi
          }
          
          # æŽ¨é€é•œåƒåˆ°å„ä¸ªä»“åº“
          push_image "${DOCKER_HUB_REPO}" "$VERSION_TAG" "Docker Hub"
          
          # æ£€æŸ¥GHCRçš„ç™»å½•çŠ¶æ€
          if [ "$GHCR_LOGIN_SUCCESS" != "true" ]; then
            echo "âš ï¸ GitHub Container Registryç™»å½•å¤±è´¥ï¼Œè·³è¿‡æŽ¨é€"
          else
            # ä¸ºGHCRæŽ¨é€æ“ä½œæ·»åŠ è¶…æ—¶ä¿æŠ¤
            timeout 30s bash -c "set +e; push_image \"${GHCR_REPO}\" \"$VERSION_TAG\" \"GitHub Container Registry\"; exit $?"
            PUSH_EXIT_CODE=$?
            
            if [ $PUSH_EXIT_CODE -eq 124 ]; then
              echo "â° GitHub Container Registryé•œåƒæŽ¨é€è¶…æ—¶ï¼ˆè¶…è¿‡30ç§’ï¼‰ï¼Œå·²è·³è¿‡"
            elif [ $PUSH_EXIT_CODE -ne 0 ] && [ $PUSH_EXIT_CODE -ne 124 ]; then
              echo "âŒ GitHub Container Registryé•œåƒæŽ¨é€å¤±è´¥ï¼Œé”™è¯¯ç : $PUSH_EXIT_CODE"
            fi
          fi
          
          # æ£€æŸ¥git.t2be.cnçš„ç™»å½•çŠ¶æ€
          if [ "$GIT2BE_LOGIN_SUCCESS" != "true" ]; then
            echo "âš ï¸ git.t2be.cnç™»å½•å¤±è´¥ï¼Œè·³è¿‡æŽ¨é€"
          else
            # æ£€æŸ¥git.t2be.cnçš„å¥åº·çŠ¶æ€ï¼Œä½¿ç”¨å¸¦è¶…æ—¶çš„curlå‘½ä»¤
            echo "ðŸ” æ£€æŸ¥git.t2be.cnä»“åº“å¥åº·çŠ¶æ€ï¼ˆè¶…æ—¶è®¾ç½®ï¼š10ç§’ï¼‰..."
            set +e  # å…è®¸æ£€æŸ¥å¤±è´¥ä½†ç»§ç»­æ‰§è¡Œ
            # ä½¿ç”¨curlè¿›è¡Œå¥åº·æ£€æŸ¥ï¼Œè®¾ç½®10ç§’è¶…æ—¶
            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" --connect-timeout 10 --max-time 10 https://git.t2be.cn/v2/)
            CURL_EXIT_CODE=$?
            
            if [ $CURL_EXIT_CODE -eq 0 ] && [ "$HTTP_STATUS" -eq 200 ]; then
              echo "âœ… git.t2be.cnä»“åº“å¯ç”¨ä¸”å“åº”æ­£å¸¸ï¼Œå‡†å¤‡æŽ¨é€é•œåƒ"
              # ä¸ºæŽ¨é€æ“ä½œä¹Ÿæ·»åŠ è¶…æ—¶ä¿æŠ¤
              timeout 30s bash -c "set +e; push_image \"${GIT2BE_REPO}\" \"$VERSION_TAG\" \"git.t2be.cn\"; exit $?"
              PUSH_EXIT_CODE=$?
              
              if [ $PUSH_EXIT_CODE -eq 124 ]; then
                echo "â° git.t2be.cné•œåƒæŽ¨é€è¶…æ—¶ï¼ˆè¶…è¿‡30ç§’ï¼‰ï¼Œå·²è·³è¿‡"
              elif [ $PUSH_EXIT_CODE -ne 0 ] && [ $PUSH_EXIT_CODE -ne 124 ]; then
                echo "âŒ git.t2be.cné•œåƒæŽ¨é€å¤±è´¥ï¼Œé”™è¯¯ç : $PUSH_EXIT_CODE"
              fi
            else
              if [ $CURL_EXIT_CODE -eq 28 ]; then
                echo "â° git.t2be.cnä»“åº“è¿žæŽ¥è¶…æ—¶ï¼ˆè¶…è¿‡10ç§’ï¼‰ï¼Œè·³è¿‡æŽ¨é€"
              else
                echo "âš ï¸ git.t2be.cnä»“åº“ä¸å¯ç”¨ï¼ˆé€€å‡ºç : $CURL_EXIT_CODE, çŠ¶æ€ç : $HTTP_STATUSï¼‰ï¼Œè·³è¿‡æŽ¨é€"
              fi
            fi
          fi
          

          
          set -e  # æ¢å¤é”™è¯¯é€€å‡ºæ¨¡å¼
          echo "âœ… é•œåƒæŽ¨é€æµç¨‹å®Œæˆ"

      # æ›´æ–°ç‰ˆæœ¬å·ã€åˆ›å»ºtagå’ŒGitHub Release
      - name: æ›´æ–°ç‰ˆæœ¬å·ã€åˆ›å»ºtagå’ŒGitHub Release
        if: success() && github.ref == 'refs/heads/main'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # è¯»å–å½“å‰ç‰ˆæœ¬å·
          CURRENT_VERSION=$(cat version.txt)
          echo "å½“å‰ç‰ˆæœ¬: $CURRENT_VERSION"
          
          # å¢žåŠ è¡¥ä¸ç‰ˆæœ¬å·ï¼ˆä¾‹å¦‚ä»Ž1.0.0åˆ°1.0.1ï¼‰
          NEW_VERSION=$(echo $CURRENT_VERSION | awk -F. '{$3=$3+1; OFS="."; print $1,$2,$3}')
          echo "æ–°ç‰ˆæœ¬: $NEW_VERSION"
          
          # æ›´æ–°version.txtæ–‡ä»¶
          echo $NEW_VERSION > version.txt
          echo "âœ… ç‰ˆæœ¬å·å·²æ›´æ–°åˆ° $NEW_VERSION"
          
          # é…ç½®gitç”¨æˆ·
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'actions@github.com'
          
          # æ·»åŠ version.txtæ–‡ä»¶
          git add version.txt
          
          # æäº¤æ›´æ”¹
          git commit -m "è‡ªåŠ¨æ›´æ–°ç‰ˆæœ¬å·åˆ° $NEW_VERSION"
          
          # æŽ¨é€æ›´æ”¹
          git push origin main
          
          # åˆ›å»ºæ–°çš„tag
          TAG_NAME="v$NEW_VERSION"
          git tag $TAG_NAME
          git push origin $TAG_NAME
          echo "âœ… åˆ›å»ºå¹¶æŽ¨é€tag: $TAG_NAME"
          
          # èŽ·å–æäº¤æ—¥å¿—ï¼Œç”¨äºŽReleaseè¯´æ˜Ž
          CHANGELOG=$(git log --pretty=format:"- %s" $(git describe --tags --abbrev=0)..HEAD)
          
          # å®‰è£…ghå‘½ä»¤è¡Œå·¥å…·ï¼ˆGitHubå®˜æ–¹CLIï¼‰
          echo "å®‰è£…GitHub CLI..."
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          sudo apt-get update
          sudo apt-get install -y gh
          
          # åˆ›å»ºGitHub Release
          echo "åˆ›å»ºGitHub Release: $TAG_NAME"
          echo "å‘å¸ƒè¯´æ˜Žå†…å®¹:\n$CHANGELOG"
          
          # ä½¿ç”¨ghå‘½ä»¤åˆ›å»ºReleaseï¼ˆä½¿ç”¨çŽ¯å¢ƒå˜é‡ç›´æŽ¥è®¤è¯ï¼Œä¸éœ€è¦å•ç‹¬çš„loginæ­¥éª¤ï¼‰
          # ç¡®ä¿CHANGELOGä¸ä¸ºç©º
          if [ -z "$CHANGELOG" ]; then
            CHANGELOG="- è‡ªåŠ¨ç‰ˆæœ¬æ›´æ–°åˆ° $NEW_VERSION"
          fi
          
          # èŽ·å–é•œåƒæ ‡ç­¾ä¿¡æ¯
          IMAGE_TAG="${NEW_VERSION}-alpine-sts"
          # ä»ŽçŽ¯å¢ƒå˜é‡èŽ·å–å°å†™ä»“åº“åï¼Œé¿å…é‡å¤è®¡ç®—
          LOWERCASE_REPO="${LOWERCASE_REPO}"
          echo "GitHub Releaseä¸­ä½¿ç”¨å°å†™ä»“åº“å: $LOWERCASE_REPO"
          
          # æž„å»ºé•œåƒä»“åº“åœ°å€åˆ—è¡¨
          DOCKER_HUB_IMAGE="${DOCKER_HUB_REPO}:${IMAGE_TAG}"
          GHCR_IMAGE="${GHCR_REPO}:${IMAGE_TAG}"

          
          # æž„å»ºä»Žghcr.ioæ‹‰å–é•œåƒçš„å‘½ä»¤
          GHCR_PULL_CMD="docker pull ${GHCR_IMAGE}"
          
          # ç›´æŽ¥ä½¿ç”¨çŽ¯å¢ƒå˜é‡è¿›è¡Œè®¤è¯å’ŒReleaseåˆ›å»º
          # æ³¨æ„ï¼šGITHUB_TOKENå·²åœ¨çŽ¯å¢ƒå˜é‡ä¸­è®¾ç½®ï¼Œghå‘½ä»¤ä¼šè‡ªåŠ¨ä½¿ç”¨å®ƒ
          echo "åˆ›å»ºGitHub Release..."
          set +e  # å…è®¸å‘½ä»¤å¤±è´¥ä½†ç»§ç»­æ‰§è¡Œ
          # åˆ›å»ºReleaseè¯´æ˜Žæ–‡æœ¬æ–‡ä»¶
          cat > release-notes.md << EOF
## ç‰ˆæœ¬ $NEW_VERSION

### æ›´æ–°å†…å®¹
$CHANGELOG

### é•œåƒä¿¡æ¯
- docker pull $DOCKER_HUB_IMAGE
- docker pull $GHCR_IMAGE
- æž„å»ºæäº¤: ${{ github.sha }}
EOF
          
          # ä½¿ç”¨æ–‡ä»¶å†…å®¹ä½œä¸ºnotesåˆ›å»ºRelease
          gh release create "$TAG_NAME" \
            --title "GoComicMosaic v$NEW_VERSION" \
            --notes-file release-notes.md \
            --prerelease=false
            
          # æ£€æŸ¥å‘½ä»¤æ˜¯å¦æˆåŠŸ
          if [ $? -eq 0 ]; then
            echo "âœ… GitHub Release åˆ›å»ºæˆåŠŸ: https://github.com/${{ github.repository }}/releases/tag/$TAG_NAME"
          else
            echo "âš ï¸ GitHub Release åˆ›å»ºå¤±è´¥ï¼Œè¿™å¯èƒ½æ˜¯ç”±äºŽæƒé™é—®é¢˜æˆ–æ ‡ç­¾å·²å­˜åœ¨ã€‚"
            echo "ä½†tagå·²æˆåŠŸåˆ›å»ºå’ŒæŽ¨é€ï¼Œç‰ˆæœ¬æ›´æ–°å·²å®Œæˆã€‚"
          fi
          set -e  # æ¢å¤é”™è¯¯ç«‹å³é€€å‡ºæ¨¡å¼

      # æž„å»ºå®ŒæˆåŽçš„é€šçŸ¥
      - name: æž„å»ºå®Œæˆé€šçŸ¥
        if: success()
        run: |
          VERSION=$(cat version.txt | tr -d '[:space:]')
          IMAGE_TAG="${VERSION}-alpine-sts"
          # ä»ŽçŽ¯å¢ƒå˜é‡èŽ·å–å°å†™ä»“åº“åå’Œä»“åº“åœ°å€
          LOWERCASE_REPO="${LOWERCASE_REPO}"
          DOCKER_HUB_REPO="${DOCKER_HUB_REPO}"
          GHCR_REPO="${GHCR_REPO}"
          GIT2BE_REPO="${GIT2BE_REPO}"

          
          echo "é€šçŸ¥ä¸­ä½¿ç”¨å°å†™ä»“åº“å: $LOWERCASE_REPO"
          echo "âœ… å®¹å™¨é•œåƒæž„å»ºå¹¶æŽ¨é€æˆåŠŸï¼"
          echo "ðŸ“š æ‰€æœ‰å¯ç”¨é•œåƒä»“åº“åœ°å€:"
          echo "  â€¢ Docker Hub: $DOCKER_HUB_REPO:$IMAGE_TAG"
          echo "  â€¢ GitHub Container Registry: $GHCR_REPO:$IMAGE_TAG"
          echo "  â€¢ GitLab (git.t2be.cn): $GIT2BE_REPO:$IMAGE_TAG"

          echo "ðŸ“¦ é•œåƒå¤§å°ä¼˜åŒ–: ä½¿ç”¨buildahæž„å»ºå‡å°ä½“ç§¯"
          echo "ðŸ“ æž„å»ºä¿¡æ¯: æäº¤SHA - ${{ github.sha }}"
          echo "âš¡ ä¼˜åŠ¿: ä¸ŽDockerç›¸æ¯”ï¼Œbuildahç”Ÿæˆçš„é•œåƒä½“ç§¯æ›´å°ï¼Œæ›´é€‚åˆç”Ÿäº§çŽ¯å¢ƒéƒ¨ç½²"
          if [ "${{ github.ref }}" = 'refs/heads/main' ]; then
            echo "ðŸš€ ç‰ˆæœ¬å·å·²æ›´æ–°åˆ° $VERSION å¹¶åˆ›å»ºäº†ç›¸åº”tag"
          fi

      # æž„å»ºå¤±è´¥æ—¶çš„æ•…éšœæŽ’é™¤ä¿¡æ¯
      - name: æž„å»ºå¤±è´¥æ•…éšœæŽ’é™¤
        if: failure()
        run: |
          echo "âŒ å®¹å™¨é•œåƒæž„å»ºå¤±è´¥ï¼"
          echo "ðŸ’¡ æ•…éšœæŽ’é™¤æç¤ºï¼š"
          echo "1. ç¡®ä¿Docker Hubå‡­è¯æ­£ç¡®è®¾ç½®åœ¨GitHub Secretsä¸­"
          echo "2. æ£€æŸ¥build-with-buildah.shè„šæœ¬è¯­æ³•æ˜¯å¦æ­£ç¡®"
          echo "3. éªŒè¯æž„å»ºçŽ¯å¢ƒç½‘ç»œè¿žæŽ¥æ˜¯å¦æ­£å¸¸"
          echo "4. æŸ¥çœ‹å®Œæ•´æ—¥å¿—ä»¥èŽ·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯"
          echo "5. ç¡®ä¿buildahå·¥å…·æ­£ç¡®å®‰è£…å¹¶å…·æœ‰è¶³å¤Ÿæƒé™"